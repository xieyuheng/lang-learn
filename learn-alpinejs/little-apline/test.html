<html>
  <head> </head>

  <body>
    <div x-data="{ count: 0 }">
      <button @click="count++" @mouseenter="count++">+</button>
      <button @click="count--" @mouseenter="count--">-</button>
      <span x-text="count"></span>
      <span x-show="count > 2">(greater than 2)</span>
    </div>

    <script>
      const directives = {
        "x-text": (el, value) => {
          el.innerText = value
        },
        "x-show": (el, value) => {
          el.style.display = value ? "initial" : "none"
        },
      }

      const root = document.querySelector("[x-data]")
      const rawData = getInitialData(root)
      const data = observe(rawData)
      registerListeners()
      refreshDom()

      function observe(data) {
        return new Proxy(data, {
          set(target, key, value) {
            target[key] = value

            refreshDom()
          },
        })
      }

      function refreshDom() {
        walkDom(root, (el) => {
          Array.from(el.attributes).forEach((attribute) => {
            if (!Object.keys(directives).includes(attribute.name)) return
            const directive = directives[attribute.name]
            directive(el, eval(`with (data) (${attribute.value})`))
          })
        })
      }

      function registerListeners() {
        walkDom(root, (el) => {
          Array.from(el.attributes).forEach((attribute) => {
            if (!attribute.name.startsWith("@")) return

            const event = attribute.name.slice(1)

            el.addEventListener(event, () => {
              eval(`with (data) (${attribute.value})`)
            })
          })
        })
      }

      function walkDom(el, callback) {
        callback(el)
        el = el.firstElementChild
        while (el) {
          walkDom(el, callback)
          el = el.nextElementSibling
        }
      }

      function getInitialData(root) {
        const dataString = root.getAttribute("x-data")
        return eval(`(${dataString})`)
      }
    </script>
  </body>
</html>
